#!/bin/sh
#--------------------------------------------------------------------------
# pg_compile
#	Compile PostgreSQL or Postgres-XC code
#	Copyright (c) 2010-2012, Michael Paquier
#	Run regressions if necessary or enforce debug flag
#--------------------------------------------------------------------------

# Take and check options
EXPECTED_ARGS=0
FLAG_DEBUG=0
FLAG_REGRESS=0
FLAG_PATH=0

# Show help
show_help()
{
	ERROR_NUM=$1
	echo "Usage: `basename $0` [OPTION]..."
	echo " "
	echo "Options:"
	echo "  -d                  Compile with debug flag"
	echo "  -h                  Show this help"
	echo "  -p PATH             Define installation folder"
	echo "  -r                  Run regressions"
	exit $ERROR_NUM
}

#Treat options
while getopts 'dhp:r' OPTION
do
	case $OPTION in
	d)	# Enforce debug flag
		FLAG_DEBUG=1
		EXPECTED_ARGS=$(($EXPECTED_ARGS + 1))
		;;
	h)	# Help
		show_help 0
		;;
	p)	# Installation folder
		FLAG_PATH=1
		USER_INSTALL_FOLDER="$OPTARG"
		EXPECTED_ARGS=$(($EXPECTED_ARGS + 2))
		;;
	r)	# Run regressions
		FLAG_REGRESS=1
		EXPECTED_ARGS=$(($EXPECTED_ARGS + 1))
		;;
	?)	# Help
		show_help 1
		;;
	esac
done

# Check number of arguments
if [ $# -ne $EXPECTED_ARGS ]
then
	show_help 1
fi

# Define installation folder
if [ "$FLAG_PATH" == 1 ]
then
	PSQL_INSTALL_FOLDER=$USER_INSTALL_FOLDER
else
	PSQL_INSTALL_FOLDER=$HOME/pgsql
	echo "Using default installation folder $PSQL_INSTALL_FOLDER"
fi

# Install Postgres-XC binaries
if [ "$FLAG_DEBUG" == 1 ]
then
	./configure --prefix=$PSQL_INSTALL_FOLDER --enable-depend --enable-debug --disable-rpath --enable-cassert --with-libxml CFLAGS="-DG"
else
	./configure --prefix=$PSQL_INSTALL_FOLDER --enable-depend --enable-debug --disable-rpath --enable-cassert --with-libxml
fi

# Compile
make

# Run regressions if necessary
if [ "$FLAG_REGRESS" == 1 ]
then
	make check
fi

# Install
make install
