#!/bin/bash
#--------------------------------------------------------------------------
# spatch
#	Configuration manager for Home
#
#	Copyright (c) 2010-2012, Michael Paquier
#
#--------------------------------------------------------------------------

# First check the keyword used as command
COMMAND_TYPE=$1
# Take the number of arguments
NUM_ARGS=$#

# Default parameters
CONFIG_FOLDER=$HOME/.spatch.d/ # General config folder
CURRENT_CONFIG=$CONFIG_FOLDER/current # Where is stored current config
VERSION="spatch version 1.0"

show_help ()
{
	echo "usage: `basename $0` [--version] [--help] <command> [args]";
	echo "";
	echo "The commands usable with `basename $0` are:";
	echo "   conf       Switch configuration set";
	echo "   conf-list  List possible configuration sets";
	echo "   conf-desc  Describe given configuration set";
	echo "   conf-show  Show current configuration set";
	echo "   env        Switch environment"
	echo "   env-list   List available environments"
}

# Check number of arguments for command
# $1 = command type
# $2 = number of arguments
check_args ()
{
	COMMAND=$1
	NUM_ARGS=$2
	ERROR=0
	if [ "$COMMAND" = "conf" ]
	then
		# Here we need new config type
		if [ "$NUM_ARGS" -gt 2 ]
		then
			ERROR=1
		fi
	elif [ "$COMMAND" = "env" ]
	then
		# We need new environment name
		if [ "$NUM_ARGS" -gt 2 ]
		then
			ERROR=1
		fi
	elif [ "$COMMAND" = "env-list" ]
	then
		# Here we do not need extra arguments
		if [ "$NUM_ARGS" -gt 1 ]
		then
			ERROR=1
		fi
	elif [ "$COMMAND" = "conf-list" ]
	then
		# Here we do not need extra arguments
		if [ "$NUM_ARGS" -gt 1 ]
		then
			ERROR=1
		fi
	elif [ "$COMMAND" = "conf-desc" ]
	then
		# Here we need a config set as argument
		if [ "$NUM_ARGS" -gt 2 ]
		then
			ERROR=1
		fi
	elif [ "$COMMAND" = "conf-show" ]
	then
		# Here we do not need extra arguments
		if [ "$NUM_ARGS" -gt 1 ]
		then
			ERROR=1
		fi
	fi

	if [ "$ERROR" = 1 ]
	then
		# Report error
		echo "Incorrect number of arguments"
		# Show help in case of error and leave
		show_help
		exit 1
	fi
}

# Execute command conf-list
command_conflist ()
{
	for folder in `ls $CONFIG_FOLDER`
	do
		# Print only the folder names
		if [ -d "$CONFIG_FOLDER/$folder" ]
		then
			echo $folder
		fi
	done
}

# Execute command conf-desc
command_confdesc ()
{
	CONFIG_NAME=$1

	# If name is empty, fallback to current
	if [ -z "$CONFIG_NAME" ]
	then
		# Be sure that current config exists
		if [  -f "$CURRENT_CONFIG" ]
		then
			CONFIG_NAME=`cat $CURRENT_CONFIG`
		fi
	fi

	# Error if still empty
	if [ -z "$CONFIG_NAME" ]
	then
		echo "No configuration set found"
		exit 1
	fi

	# Now we are sure that the current configuration has been read or that
	# There is a configuration defined, but we are not sure if it exists,
	# So check it.
	if [ ! -d $CONFIG_FOLDER/$CONFIG_NAME ]
	then
		echo "Incorrect configuration set"
		exit 1
	fi

	DESC_FILE=$CONFIG_FOLDER/$CONFIG_NAME/DESCRIPTION
	# Check presence of a description file
	if [ ! -f $DESC_FILE ]
	then
		echo "No description available"
		exit 1
	fi

	# OK now print description of configuration set
	echo `cat $DESC_FILE`
}

# Execute command conf
command_conf ()
{
	echo "new configuration: $1"
	echo "Not implemented yet"
	exit 1
}

# Execute command conf-show
command_confshow ()
{
	echo "current configuration"
	echo "Not implemented yet"
	exit 1
}

# Execute command env
command_env ()
{
	NEW_ENV=$1
	if [ -z $NEW_ENV ]
	then
		echo "Environment not specified"
		show_help
		exit 1
	fi

	# OK to switch environment
	cd $HOME
	git checkout $NEW_ENV > /dev/null 2>&1
	ERROR=$?
	if [ "$ERROR" = 0 ]
	then
		echo "Switched to environment $NEW_ENV"
	else
		echo "Incorrect environment $NEW_ENV"
	fi
}

command_envlist ()
{
	echo "List of Home environments:"
	cd $HOME
	git branch
}

# Check the list of arguments
check_args $COMMAND_TYPE $NUM_ARGS

if [ "$COMMAND_TYPE" = "conf" ]
then
	command_conf $2
elif [ "$COMMAND_TYPE" = "--version" ]
then
	echo $VERSION
elif [ "$COMMAND_TYPE" = "--help" ]
then
	show_help
elif [ "$COMMAND_TYPE" = "env" ]
then
	# List the possible configurations
	command_env $2
elif [ "$COMMAND_TYPE" = "env-list" ]
then
	# List the possible configurations
	command_envlist
elif [ "$COMMAND_TYPE" = "conf-list" ]
then
	# List the possible configurations
	command_conflist
elif [ "$COMMAND_TYPE" = "conf-desc" ]
then
	# Show description of given configuration
	command_confdesc $2
elif [ "$COMMAND_TYPE" = "conf-show" ]
then
	command_confshow
else
	# Report incorrect command
	echo "Incorrect command"
	# Show help and return error
	show_help
	exit 1
fi

exit 0
